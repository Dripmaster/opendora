.......F....F..FF............................                            [100%]
=================================== FAILURES ===================================
________________ test_deep_agent_subagent_blocked_and_aggregate ________________

tmp_path = PosixPath('/tmp/pytest-of-wbsoft/pytest-5/test_deep_agent_subagent_block0')

    async def test_deep_agent_subagent_blocked_and_aggregate(tmp_path):
        codex = FakeCodex(
            [
                '{"offloadIds":[],"liveMessageIds":[]}',
                '{"mode":"subagent_pipeline","reason":"complex"}',
                '{"todos":[{"id":"T1","title":"first","instructions":"do-1","priority":"high","dependsOn":[],"doneDefinition":"done"},{"id":"T2","title":"second","instructions":"do-2","priority":"medium","dependsOn":["TX"],"doneDefinition":"done"}]}',
                '{"offloadIds":[],"liveMessageIds":[]}',
                "subagent-output",
                '{"done":true,"reason":"complete","nextTodos":[]}',
                "final-aggregate",
            ]
        )
        tools = DeepAgentToolsService(codex=codex)  # type: ignore[arg-type]
        context = ContextOffloadService(
            ContextOffloadOptions(True, str(tmp_path / "ctx"), 12000, 10, 4)
        )
        agent = DeepAgentService(
            codex=codex, context_offload=context, tools=tools,
            options=DeepAgentOptions(enabled=True, max_subagents=3, max_rounds=3),
        )  # type: ignore[arg-type]
    
>       result = await agent.execute("c:u", "build this", ".")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_deep_agent.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/orchestrator/services/deep_agent.py:661: in execute
    state = await chain.ainvoke(
.venv/lib/python3.13/site-packages/langgraph/pregel/main.py:3161: in ainvoke
    async for chunk in self.astream(
.venv/lib/python3.13/site-packages/langgraph/pregel/main.py:2974: in astream
    async for _ in runner.atick(
.venv/lib/python3.13/site-packages/langgraph/pregel/_runner.py:304: in atick
    await arun_with_retry(
.venv/lib/python3.13/site-packages/langgraph/pregel/_retry.py:138: in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/langgraph/_internal/_runnable.py:705: in ainvoke
    input = await asyncio.create_task(
.venv/lib/python3.13/site-packages/langgraph/_internal/_runnable.py:473: in ainvoke
    ret = await self.afunc(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/orchestrator/services/deep_agent.py:238: in validate_todo_plan_node
    decision = await self.tools.invoke_replan(
src/orchestrator/services/deep_agent_tools.py:374: in invoke_replan
    raw = await self._run_json_with_retry(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = DeepAgentToolsService(codex=<test_deep_agent.FakeCodex object at 0x767f7d3b8a50>)
repo_path = '.'
prompt = 'Role: main agent quality gate and replanner.\nGoal: determine if user request is fully complete after subagent execut...esults]\n\n[All Todo Results]\n\n[All Subagent Outputs]\n\n[Offloaded Context Summary]\n\n[Live Conversation Excerpts]'
attempts = 2
schema = <class 'orchestrator.services.deep_agent_tools.ReplanDecision'>

    async def _run_json_with_retry(
        self,
        repo_path: str,
        prompt: str,
        attempts: int = 2,
        schema: type[BaseModel] | None = None,
    ) -> dict[str, Any]:
        last_raw = ""
        last_error = ""
        for i in range(attempts):
            actual_prompt = prompt
            if i > 0:
                actual_prompt = "\n".join(
                    [
                        prompt,
                        "",
                        "[Previous invalid output]",
                        truncate(last_raw or "(none)", 1200),
                        "",
                        "Retry now and return ONLY valid one-line JSON following the schema exactly.",
                    ]
                )
            result = await self.codex.run(repo_path=repo_path, prompt=actual_prompt)
            last_raw = result.assistant_message.strip()
            parsed = extract_json_line(last_raw)
            if parsed is None:
                last_error = "parse_failed"
                self._log_retry_issue(
                    attempt=i + 1,
                    attempts=attempts,
                    reason="JSON parsing failed",
                    raw=last_raw,
                )
                continue
            if schema is not None:
                try:
                    schema.model_validate(parsed)
                except ValidationError as exc:
                    last_error = f"schema_failed:{exc.errors()[:2]}"
                    self._log_retry_issue(
                        attempt=i + 1,
                        attempts=attempts,
                        reason="Schema validation failed",
                        raw=last_raw,
                    )
                    continue
            return parsed
>       raise ValueError(
            "failed to parse valid JSON from model"
            f" (last_error={last_error or 'unknown'}, last_output={truncate(last_raw or '(empty)', 240)})"
        )
E       ValueError: failed to parse valid JSON from model (last_error=parse_failed, last_output=subagent-output)
E       During task with name 'validate_todo_plan' and id '37963f8f-dff1-6ff2-bb11-4dbae03f0ca0'

src/orchestrator/services/deep_agent_tools.py:470: ValueError
_________________ test_deep_agent_skip_and_stop_round_control __________________

tmp_path = PosixPath('/tmp/pytest-of-wbsoft/pytest-5/test_deep_agent_skip_and_stop_0')

    async def test_deep_agent_skip_and_stop_round_control(tmp_path):
        codex = FakeCodex(
            [
                '{"offloadIds":[],"liveMessageIds":[]}',
                '{"mode":"subagent_pipeline","reason":"complex"}',
                '{"todos":[{"id":"T1","title":"first","instructions":"do-1","priority":"high","dependsOn":[],"doneDefinition":"done"},{"id":"T2","title":"second","instructions":"do-2","priority":"high","dependsOn":[],"doneDefinition":"done"}]}',
                '{"offloadIds":[],"liveMessageIds":[]}',
                "round1-output",
                "final-aggregate",
            ]
        )
        tools = DeepAgentToolsService(codex=codex)  # type: ignore[arg-type]
        context = ContextOffloadService(
            ContextOffloadOptions(True, str(tmp_path / "ctx"), 12000, 10, 4)
        )
        agent = DeepAgentService(
            codex=codex, context_offload=context, tools=tools,
            options=DeepAgentOptions(enabled=True, max_subagents=3, max_rounds=3),
        )  # type: ignore[arg-type]
    
        events: list[dict[str, str]] = []
    
        async def progress(event: dict[str, str]):
            events.append(event)
    
        async def inputs(todo_id: str):
            if todo_id == "T2":
                return ["__control__:skip", "__control__:stop-round"]
            return []
    
>       result = await agent.execute("c:u", "build this", ".", on_progress=progress, todo_input_provider=inputs)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_deep_agent.py:238: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/orchestrator/services/deep_agent.py:661: in execute
    state = await chain.ainvoke(
.venv/lib/python3.13/site-packages/langgraph/pregel/main.py:3161: in ainvoke
    async for chunk in self.astream(
.venv/lib/python3.13/site-packages/langgraph/pregel/main.py:2974: in astream
    async for _ in runner.atick(
.venv/lib/python3.13/site-packages/langgraph/pregel/_runner.py:304: in atick
    await arun_with_retry(
.venv/lib/python3.13/site-packages/langgraph/pregel/_retry.py:138: in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/langgraph/_internal/_runnable.py:705: in ainvoke
    input = await asyncio.create_task(
.venv/lib/python3.13/site-packages/langgraph/_internal/_runnable.py:473: in ainvoke
    ret = await self.afunc(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/orchestrator/services/deep_agent.py:337: in run_subagents
    selected = await self.tools.invoke_select_context(
src/orchestrator/services/deep_agent_tools.py:202: in invoke_select_context
    raw = await self._run_json_with_retry(
src/orchestrator/services/deep_agent_tools.py:445: in _run_json_with_retry
    result = await self.codex.run(repo_path=repo_path, prompt=actual_prompt)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <test_deep_agent.FakeCodex object at 0x767f7c085e10>, repo_path = '.'
prompt = 'Role: context selector for one subagent task.\nGoal: choose the smallest useful context subset.\nOutput contract: ret...evious invalid output]\nfinal-aggregate\n\nRetry now and return ONLY valid one-line JSON following the schema exactly.'

    async def run(self, repo_path: str, prompt: str):
        self.prompts.append(prompt)
>       text = self.outputs.pop(0)
               ^^^^^^^^^^^^^^^^^^^
E       IndexError: pop from empty list
E       During task with name 'run_subagents' and id 'd0d1eb98-c512-73d6-2a23-22e3fa73147f'

tests/test_deep_agent.py:21: IndexError
________________________ test_deep_agent_abort_control _________________________

tmp_path = PosixPath('/tmp/pytest-of-wbsoft/pytest-5/test_deep_agent_abort_control0')

    async def test_deep_agent_abort_control(tmp_path):
        codex = FakeCodex(
            [
                '{"offloadIds":[],"liveMessageIds":[]}',
                '{"mode":"subagent_pipeline","reason":"complex"}',
                '{"todos":[{"id":"T1","title":"first","instructions":"do-1","priority":"high","dependsOn":[],"doneDefinition":"done"}]}',
                "final-aggregate",
            ]
        )
        tools = DeepAgentToolsService(codex=codex)  # type: ignore[arg-type]
        context = ContextOffloadService(
            ContextOffloadOptions(True, str(tmp_path / "ctx"), 12000, 10, 4)
        )
        agent = DeepAgentService(
            codex=codex, context_offload=context, tools=tools,
            options=DeepAgentOptions(enabled=True, max_subagents=3, max_rounds=3),
        )  # type: ignore[arg-type]
    
        events: list[dict[str, str]] = []
    
        async def progress(event: dict[str, str]):
            events.append(event)
    
        async def inputs(_todo_id: str):
            return ["__control__:abort"]
    
>       result = await agent.execute("c:u", "build this", ".", on_progress=progress, todo_input_provider=inputs)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_deep_agent.py:328: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/orchestrator/services/deep_agent.py:661: in execute
    state = await chain.ainvoke(
.venv/lib/python3.13/site-packages/langgraph/pregel/main.py:3161: in ainvoke
    async for chunk in self.astream(
.venv/lib/python3.13/site-packages/langgraph/pregel/main.py:2974: in astream
    async for _ in runner.atick(
.venv/lib/python3.13/site-packages/langgraph/pregel/_runner.py:304: in atick
    await arun_with_retry(
.venv/lib/python3.13/site-packages/langgraph/pregel/_retry.py:138: in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/langgraph/_internal/_runnable.py:705: in ainvoke
    input = await asyncio.create_task(
.venv/lib/python3.13/site-packages/langgraph/_internal/_runnable.py:473: in ainvoke
    ret = await self.afunc(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/orchestrator/services/deep_agent.py:337: in run_subagents
    selected = await self.tools.invoke_select_context(
src/orchestrator/services/deep_agent_tools.py:202: in invoke_select_context
    raw = await self._run_json_with_retry(
src/orchestrator/services/deep_agent_tools.py:445: in _run_json_with_retry
    result = await self.codex.run(repo_path=repo_path, prompt=actual_prompt)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <test_deep_agent.FakeCodex object at 0x767f7bfec250>, repo_path = '.'
prompt = 'Role: context selector for one subagent task.\nGoal: choose the smallest useful context subset.\nOutput contract: ret...evious invalid output]\nfinal-aggregate\n\nRetry now and return ONLY valid one-line JSON following the schema exactly.'

    async def run(self, repo_path: str, prompt: str):
        self.prompts.append(prompt)
>       text = self.outputs.pop(0)
               ^^^^^^^^^^^^^^^^^^^
E       IndexError: pop from empty list
E       During task with name 'run_subagents' and id 'e5300ce0-dfbf-03a7-74d9-e2c8d0959c87'

tests/test_deep_agent.py:21: IndexError
________ test_validate_todo_plan_detects_duplicate_undefined_and_cycle _________

    def test_validate_todo_plan_detects_duplicate_undefined_and_cycle():
        errors = validate_todo_plan(
            [
                {"id": "T1", "dependsOn": ["T2"]},
                {"id": "T2", "dependsOn": ["T1", "T9"]},
                {"id": "T1", "dependsOn": []},
            ]
        )
    
        assert any("duplicate ids" in item for item in errors)
        assert any("undefined dependsOn references" in item for item in errors)
>       assert any("cyclic dependency detected" in item for item in errors)
E       assert False
E        +  where False = any(<generator object test_validate_todo_plan_detects_duplicate_undefined_and_cycle.<locals>.<genexpr> at 0x767f7a7c57d0>)

tests/test_deep_agent.py:346: AssertionError
=========================== short test summary info ============================
FAILED tests/test_deep_agent.py::test_deep_agent_subagent_blocked_and_aggregate - ValueError: failed to parse valid JSON from model (last_error=parse_failed, last_output=subagent-output)
During task with name 'validate_todo_plan' and id '37963f8f-dff1-6ff2-bb11-4dbae03f0ca0'
FAILED tests/test_deep_agent.py::test_deep_agent_skip_and_stop_round_control - IndexError: pop from empty list
During task with name 'run_subagents' and id 'd0d1eb98-c512-73d6-2a23-22e3fa73147f'
FAILED tests/test_deep_agent.py::test_deep_agent_abort_control - IndexError: pop from empty list
During task with name 'run_subagents' and id 'e5300ce0-dfbf-03a7-74d9-e2c8d0959c87'
FAILED tests/test_deep_agent.py::test_validate_todo_plan_detects_duplicate_undefined_and_cycle - assert False
 +  where False = any(<generator object test_validate_todo_plan_detects_duplicate_undefined_and_cycle.<locals>.<genexpr> at 0x767f7a7c57d0>)
4 failed, 41 passed in 0.82s
